<!DOCTYPE html>
<html>
<head>
    <title>Iron & Asphalt: Persistence Edition</title>
    <style>
        body { margin: 0; background: #222; overflow: hidden; font-family: 'Segoe UI', Tahoma, Verdana, sans-serif; color: white; user-select: none; }
        canvas { display: block; }
        
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.85); z-index: 100; text-align: center;
        }
        .hidden { display: none !important; }
        
        h1 { font-size: 60px; margin: 0 0 20px 0; color: #0ff; text-shadow: 0 0 20px #0ff; letter-spacing: 4px; }
        
        .menu-group { display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .btn {
            background: linear-gradient(#444, #111); border: 2px solid #555; color: #fff;
            padding: 12px 30px; font-size: 18px; cursor: pointer; border-radius: 8px;
            transition: 0.2s; width: 280px; font-weight: bold; margin: 5px;
        }
        .btn:hover { background: #0ff; color: #000; border-color: #fff; transform: scale(1.05); }
        .btn-reset { background: linear-gradient(#800, #300); border-color: #f33; margin-top: 20px; }

        #level-grid {
            display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px;
            max-height: 300px; overflow-y: auto; padding: 15px; background: #111;
            border: 2px solid #444; margin-bottom: 20px;
        }
        .lvl-btn { padding: 8px; background: #333; border: 1px solid #555; color: white; cursor: pointer; font-size: 11px; }
        .lvl-btn:hover:not(.locked) { background: #0ff; color: #000; }
        .lvl-btn.locked { opacity: 0.3; cursor: not-allowed; }

        #hud {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px;
            border-left: 5px solid #0ff; pointer-events: none;
        }
        .stat { font-size: 18px; margin-bottom: 5px; }
        #level-indicator { position: absolute; top: 20px; right: 20px; font-size: 24px; color: #ffd700; font-weight: 900; }
    </style>
</head>
<body>

    <div id="hud" class="hidden">
        <div class="stat"><b>LV SPEED:</b> <span id="ui-speed" style="color:#0f0">0</span></div>
        <div class="stat"><b>DIST:</b> <span id="ui-dist">0</span>m / 250m</div>
        <div class="stat"><b>COINS:</b> <span id="ui-coins">0</span></div>
        <div class="stat"><b>LIVES:</b> <span id="ui-lives" style="color:#ff3366"></span></div>
    </div>
    <div id="level-indicator" class="hidden">LEVEL 1</div>

    <div id="main-menu" class="overlay">
        <h1>IRON & ASPHALT</h1>
        <div class="menu-group">
            <button class="btn" onclick="showLevelSelect()">Select Level (1-1099)</button>
            <button class="btn" onclick="showShop()">Bicycle Garage</button>
            <button class="btn btn-reset" onclick="resetGame()">Reset Progress</button>
        </div>
    </div>

    <div id="level-menu" class="overlay hidden">
        <h1>CHOOSE LEVEL</h1>
        <div id="level-grid"></div>
        <button class="btn" onclick="hideLevelSelect()">Back</button>
    </div>

    <div id="victory-screen" class="overlay hidden">
        <h1 style="color:#0f8">GAUNTLET CLEARED!</h1>
        <h2 style="color:#ffd700">+50 COMPLETION BONUS!</h2>
        <div class="menu-group">
            <button class="btn" onclick="nextLevel()">Next Level</button>
            <button class="btn" onclick="location.reload()">Exit to Menu</button>
        </div>
    </div>

    <div id="shop-menu" class="overlay hidden">
        <h1>GARAGE</h1>
        <p>Your Total Coins: <span id="shop-coin-count">0</span></p>
        <div id="bike-list" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px;"></div>
        <button class="btn" style="margin-top:20px" onclick="hideShop()">Back</button>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let gameState = 'MENU', currentLevel = 1, bossActive = false;

// Persistent Data
let save = JSON.parse(localStorage.getItem('ironAsphaltPersist')) || {
    coins: 0, unlocked: ['default'], selected: 'default', maxLevelReached: 1
};

const BIKES = {
    default: { jumps: 2, color: '#0af', lives: 3, price: 0 },
    rocket:  { jumps: 2, color: '#ff3366', lives: 3, price: 500 },
    rainbow: { jumps: 3, color: 'rainbow', lives: 3, price: 1500 },
    phantom: { jumps: 2, color: '#aaa', lives: 5, price: 3000 },
    omega:   { jumps: 4, color: '#0f0', lives: 6, price: 8000 }
};

let distance, gameSpeed, lives, player, hazards, coins, groundOffset = 0;
const gravity = 0.6;
const jumpStrength = 13; 
const groundY = window.innerHeight - 100;

function saveGame() { 
    localStorage.setItem('ironAsphaltPersist', JSON.stringify(save)); 
}

function initGame(lvl) {
    currentLevel = lvl; distance = 0; bossActive = false;
    lives = BIKES[save.selected].lives;
    gameSpeed = 10 + (lvl * 0.25); 
    hazards = []; coins = [];
    player = { x: 100, y: groundY-50, w: 60, h: 50, velY: 0, jumpsLeft: BIKES[save.selected].jumps, maxJumps: BIKES[save.selected].jumps, invincibility: 0 };
    document.getElementById('hud').classList.remove('hidden');
    document.getElementById('level-indicator').classList.remove('hidden');
}

function spawnObstacle() {
    const seed = currentLevel * 999 + hazards.length;
    const rng = (Math.sin(seed) * 10000) % 1;
    const lastX = hazards.length > 0 ? hazards[hazards.length - 1].x : window.innerWidth;
    const spacing = (bossActive ? 180 : 350) + Math.abs(rng * 250);
    const x = lastX + spacing;
    const typeRoll = Math.abs(rng);

    if (typeRoll < 0.04) {
        hazards.push({ type: 'ramp', x, y: groundY - 40, w: 100, h: 40 });
    } else if (typeRoll < 0.15) {
        hazards.push({ type: 'nails', x, y: groundY - 15, w: 150, h: 15 });
    } else if (typeRoll < 0.30) {
        hazards.push({ type: 'mine', x, y: groundY - 100, w: 35, h: 35, offset: Math.random()*10 });
    } else if (typeRoll < 0.45) {
        hazards.push({ type: 'spike', x, y: groundY - 40, w: 40, h: 40 });
    } else if (typeRoll < 0.60) {
        hazards.push({ type: 'wall', x, y: groundY - 100, w: 35, h: 100 });
    } else if (typeRoll < 0.75) {
        hazards.push({ type: 'triSpike', x, y: groundY - 40, w: 90, h: 40 });
    } else if (typeRoll < 0.85) {
        hazards.push({ type: 'cone', x, y: groundY - 35, w: 30, h: 35 });
    } else {
        hazards.push({ type: 'beam', x, y: groundY - 150, radius: 40, angle: 0, orbit: 90 });
    }
}

function update() {
    if (gameState !== 'PLAYING') return;

    player.velY += gravity; player.y += player.velY;
    if (player.y + player.h > groundY) { player.y = groundY - player.h; player.velY = 0; player.jumpsLeft = player.maxJumps; }

    groundOffset -= gameSpeed;
    distance += gameSpeed / 60;

    if (distance > 180 && !bossActive) bossActive = true;
    if (distance >= 250) { levelComplete(); return; }

    if (hazards.length < 15) spawnObstacle();
    if (Math.random() < 0.04) coins.push({ x: window.innerWidth + 100, y: groundY - 100 - Math.random() * 100, w: 20, h: 20 });

    hazards.forEach((h, i) => {
        h.x -= gameSpeed;
        let hit = false;
        if(h.type === 'mine') h.y = (groundY - 120) + Math.sin((Date.now() / 200) + h.offset) * 40;
        if (player.x < h.x + h.w && player.x + player.w > h.x && player.y < h.y + h.h && player.y + player.h > h.y) {
            if (h.type === 'ramp') player.velY = -17; else hit = true;
        }
        if (hit && player.invincibility <= 0) {
            lives--; player.invincibility = 60;
            if (lives <= 0) gameOver();
            updateHUD();
        }
    });

    coins.forEach((c, i) => {
        c.x -= gameSpeed;
        if (player.x < c.x + c.w && player.x + player.w > c.x && player.y < c.y + c.h && player.y + player.h > c.y) {
            save.coins += 10; 
            coins.splice(i, 1); 
            saveGame(); // SAVE INSTANTLY ON PICKUP
            updateHUD();
        }
    });

    hazards = hazards.filter(h => h.x > -400);
    if (player.invincibility > 0) player.invincibility--;
    draw();
    requestAnimationFrame(update);
}

function draw() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    ctx.fillStyle = bossActive ? '#400' : '#000428'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#111'; ctx.fillRect(0, groundY, canvas.width, 100);

    ctx.fillStyle = '#ffd700'; coins.forEach(c => { ctx.beginPath(); ctx.arc(c.x+10, c.y+10, 10, 0, 6.28); ctx.fill(); });

    hazards.forEach(h => {
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 1;
        if (h.type === 'nails') {
            ctx.fillStyle = '#aaa'; for(let n=0; n < h.w; n+=15) { ctx.beginPath(); ctx.moveTo(h.x+n, h.y+h.h); ctx.lineTo(h.x+n+7, h.y); ctx.lineTo(h.x+n+15, h.y+h.h); ctx.fill(); }
        } else if (h.type === 'mine') {
            ctx.fillStyle = '#f00'; ctx.beginPath(); ctx.arc(h.x+h.w/2, h.y+h.h/2, 15, 0, 6.28); ctx.fill();
        } else if (h.type === 'triSpike') {
            ctx.fillStyle = '#f33'; for(let j=0; j<3; j++){ ctx.beginPath(); ctx.moveTo(h.x+(j*30), h.y+40); ctx.lineTo(h.x+15+(j*30), h.y); ctx.lineTo(h.x+30+(j*30), h.y+40); ctx.fill(); }
        } else if (h.type === 'ramp') {
            ctx.fillStyle = '#0f0'; ctx.beginPath(); ctx.moveTo(h.x, h.y+40); ctx.lineTo(h.x+100, h.y); ctx.lineTo(h.x+100, h.y+40); ctx.fill();
        } else if (h.type === 'spike') {
            ctx.fillStyle = '#f36'; ctx.beginPath(); ctx.moveTo(h.x, h.y+40); ctx.lineTo(h.x+20, h.y); ctx.lineTo(h.x+40, h.y+40); ctx.fill();
        } else if (h.type === 'wall') {
            ctx.fillStyle = '#555'; ctx.fillRect(h.x, h.y, h.w, h.h);
        } else if (h.type === 'cone') {
            ctx.fillStyle = '#f60'; ctx.beginPath(); ctx.moveTo(h.x, h.y+35); ctx.lineTo(h.x+15, h.y); ctx.lineTo(h.x+30, h.y+35); ctx.fill();
        } else if (h.type === 'beam') {
            const bx = h.x + Math.cos(h.angle+=0.05) * h.orbit; const by = h.y + Math.sin(h.angle) * h.orbit;
            ctx.fillStyle = '#0ff'; ctx.beginPath(); ctx.arc(bx, by, 15, 0, 6.28); ctx.fill();
        }
    });

    if(bossActive && distance < 195) { ctx.fillStyle = '#ff0'; ctx.font = "bold 40px Arial"; ctx.textAlign = "center"; ctx.fillText("BOSS GAUNTLET!", canvas.width/2, 150); }

    if (player.invincibility % 10 < 5) {
        const b = BIKES[save.selected]; ctx.save(); ctx.translate(player.x, player.y);
        ctx.strokeStyle = b.color === 'rainbow' ? `hsl(${Date.now()%360}, 70%, 50%)` : b.color; ctx.lineWidth = 4;
        ctx.beginPath(); ctx.moveTo(10, 40); ctx.lineTo(30, 10); ctx.lineTo(50, 40); ctx.stroke();
        ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(10, 40, 12, 0, 6.28); ctx.fill(); ctx.beginPath(); ctx.arc(50, 40, 12, 0, 6.28); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(30, 0, 8, 0, 6.28); ctx.fill(); ctx.restore();
    }
}

function levelComplete() {
    gameState = 'MENU';
    save.coins += 50; // BONUS POINTS
    if(currentLevel === save.maxLevelReached) save.maxLevelReached++;
    saveGame();
    document.getElementById('victory-screen').classList.remove('hidden');
}

function gameOver() { 
    saveGame(); // Final save of all collected coins before reloading
    alert("CRASHED! But you kept your coins."); 
    location.reload(); 
}

function showLevelSelect() {
    document.getElementById('main-menu').classList.add('hidden');
    document.getElementById('level-menu').classList.remove('hidden');
    const grid = document.getElementById('level-grid'); grid.innerHTML = '';
    for(let i=1; i<=1099; i++) {
        const b = document.createElement('button'); b.className = 'lvl-btn' + (i > save.maxLevelReached ? ' locked' : '');
        b.innerText = i; b.onclick = () => { if(i <= save.maxLevelReached) startLevel(i); }; grid.appendChild(b);
    }
}
function startLevel(lvl) { document.getElementById('level-menu').classList.add('hidden'); document.getElementById('main-menu').classList.add('hidden'); gameState = 'PLAYING'; initGame(lvl); update(); }
function nextLevel() { document.getElementById('victory-screen').classList.add('hidden'); startLevel(currentLevel + 1); }
function resetGame() { if(confirm("Reset all progress and coins?")) { localStorage.removeItem('ironAsphaltPersist'); location.reload(); } }

function showShop() {
    document.getElementById('main-menu').classList.add('hidden'); document.getElementById('shop-menu').classList.remove('hidden');
    document.getElementById('shop-coin-count').innerText = save.coins;
    const list = document.getElementById('bike-list'); list.innerHTML = '';
    Object.keys(BIKES).forEach(id => {
        const b = BIKES[id]; const owned = save.unlocked.includes(id);
        list.innerHTML += `<div style="background:#333; padding:10px; border:2px solid ${save.selected==id?'#0ff':'#555'}">
            <b>${id.toUpperCase()}</b><br>Lives: ${b.lives}<br><button class="btn" style="width:120px" onclick="${owned?'selectBike':'buyBike'}('${id}',${b.price})">${owned?(save.selected==id?'Selected':'Select'):'Buy '+b.price}</button></div>`;
    });
}
function buyBike(id, p) { if(save.coins>=p){ save.coins-=p; save.unlocked.push(id); save.selected=id; saveGame(); showShop(); } }
function selectBike(id) { save.selected=id; saveGame(); showShop(); }
function hideShop() { document.getElementById('shop-menu').classList.add('hidden'); document.getElementById('main-menu').classList.remove('hidden'); }
function hideLevelSelect() { document.getElementById('level-menu').classList.add('hidden'); document.getElementById('main-menu').classList.remove('hidden'); }
function updateHUD() { 
    document.getElementById('ui-dist').innerText = Math.floor(distance); 
    document.getElementById('ui-coins').innerText = save.coins; 
    document.getElementById('ui-lives').innerText = "â¤".repeat(lives); 
    document.getElementById('ui-speed').innerText = gameSpeed.toFixed(1);
}
window.onkeydown = (e) => { if (gameState === 'PLAYING' && e.code === 'Space' && player.jumpsLeft > 0) { player.velY = -jumpStrength; player.jumpsLeft--; } };
draw(); updateHUD();
</script>
</body>
</html>
